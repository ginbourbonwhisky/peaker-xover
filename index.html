<!DOCTYPE html>
<html lang="ja">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Speaker Xover (2-way)</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:16px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end;margin:8px 0}
  label{display:flex;flex-direction:column;font-size:12px}
  input,select,button{padding:8px;border:1px solid #ccc;border-radius:6px}
  fieldset{border:1px solid #ddd;border-radius:8px;padding:8px}
  legend{font-size:12px;color:#666}
  .row-inline{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  fieldset.toggles{display:flex;gap:14px;align-items:center;margin:0}
  fieldset.toggles label{display:flex;flex-direction:row;align-items:center;gap:6px}
  #results{white-space:pre-wrap;font-family:ui-monospace,Menlo,monospace;font-size:12px;margin-top:12px}
  canvas{background:#fff;border-radius:8px;max-width:980px}
</style>
<h1>スピーカーネットワーク設計（2‑way）</h1>
<div class="row">
  <label>システム
    <select id="system">
      <option value="2way" selected>2-way</option>
      <option value="3way">3-way（UIのみ/次版で計算）</option>
    </select>
  </label>
  <label>SPL基準
    <select id="spl-basis">
      <option value="minSensitivity" selected>最小能率を基準</option>
      <option value="targetSystemSPL">システム目標SPLを入力</option>
    </select>
  </label>
  <label id="target-wrap">目標SPL (dB/2.83V/1m)
    <input id="target-spl" type="number" step="0.1" placeholder="例: 90.0">
  </label>
  <label>クロス周波数(Hz)
    <input id="fc1" type="number" value="1800">
  </label>
</div>

<h3>ウーファー</h3>
<div class="row">
  <label>Ω<input id="wz" type="number" value="8"></label>
  <label>dB<input id="wspl" type="number" value="90" step="0.1"></label>
  <label>特性
    <select id="wtype"><option>LR2</option><option>LR4</option><option>Butterworth</option><option>Bessel</option></select>
  </label>
  <label>Zobel（Re/Le自動推定）
    <select id="wzobel"><option value="on" selected>ON</option><option value="off">OFF</option></select>
  </label>
</div>

<h3>ツイーター</h3>
<div class="row">
  <label>Ω<input id="tz" type="number" value="8"></label>
  <label>dB<input id="tspl" type="number" value="98" step="0.1"></label>
  <label>特性
    <select id="ttype"><option>LR2</option><option selected>LR4</option><option>Butterworth</option><option>Bessel</option></select>
  </label>
  <label>ツイーター減衰（自動・名目Z維持）
    <select id="tlpad"><option value="auto" selected>自動</option><option value="off">OFF</option></select>
  </label>
</div>

<div class="row row-inline">
  <button id="calc">計算する</button>
  <fieldset class="toggles">
    <legend>グラフ表示</legend>
    <label><input type="checkbox" id="show-woo" checked> Woofer</label>
    <label><input type="checkbox" id="show-twe" checked> Tweeter</label>
    <label><input type="checkbox" id="show-sum" checked> Sum</label>
    <label><input type="checkbox" id="show-snapped" checked> Snapped</label>
    <label><input type="checkbox" id="show-delta"> Delta</label>
  </fieldset>
</div>

<canvas id="plot" height="260"></canvas>
<div id="results"></div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const el=id=>document.getElementById(id);
  const takman=[0.1,0.2,0.3,0.5,1,1.2,1.5,1.8,2,3,3.3,3.9,4.3,4.7,5,5.6,6.2,6.8,7.5,8.2,9.1,10,12,15,18,20,24,30,39,43,47,51,62,75,82,100,120,150,180,200,220,240,270,300,330,390,430,470,510,560,680,750,820,1000,1200,1500,1800,2000,3000,4300,4700,5000,9100,10000,15000].map(x=>x>=1000?x/1000:x);
  function dbToRatio(db){return Math.pow(10,db/20)}
  function ratioToDb(r){return 20*Math.log10(Math.max(r,1e-12))}
  function lpad(z,att){const A=dbToRatio(att);if(A<=1)return{Rs:0,Rp:Infinity,Zin:z,A:1};const Rs=z*(A-1)/A;const Rp=z*A/(A-1);const Zin=Rs+1/(1/Rp+1/z);return{Rs,Rp,Zin,A}}
  function snapR(target,tol=0.05){let best=null;const push=(val,parts)=>{const err=Math.abs(val-target)/target;if(err<=tol&&(!best||err<best.err))best={val,err,parts}};for(const r of takman)push(r,[`${r}Ω`]);for(const r1 of takman)for(const r2 of takman)push(r1+r2,[`${r1}Ω+${r2}Ω`]);for(const r1 of takman)for(const r2 of takman){const v=1/(1/r1+1/r2);push(v,[`${r1}Ω||${r2}Ω`])}return best}
  function estimateZobel(zNom,fc){const Re=0.8*zNom;const Le=zNom/(2*Math.PI*fc*5);const Rz=Re;const Cz=Le/(Rz*Rz);return{Re,Le,Rz,Cz}}
  function autoPol(w,t){const evenW=(w==='LR2'||w==='LR4'||w==='Butterworth');const evenT=(t==='LR2'||t==='LR4'||t==='Butterworth');return (evenW&&evenT)?'invert':'normal'}
  function fmtOhm(x){return x===Infinity?'∞':(Math.round(x*100)/100).toFixed(2)+' Ω'}
  function fmtCap(c){return (c*1e6).toFixed(3)+' µF'}
  function fmtInd(l){return (l*1e3).toFixed(3)+' mH'}
  function magLP(type,f,fc){
    const x=f/fc;
    if(type==='LR2'){return 1/Math.sqrt(1+Math.pow(x,4))}
    if(type==='LR4'){return 1/Math.sqrt(1+Math.pow(x,8))}
    if(type==='Butterworth'){return 1/Math.sqrt(1+Math.pow(x,4))}
    if(type==='Bessel'){
      const num=3;
      const den=Math.sqrt(Math.pow(x,4)+3*Math.pow(x,2)+3);
      return Math.min(1,num/den);
    }
    return 1/Math.sqrt(1+x*x)
  }
  function magHP(type,f,fc){
    const x=fc/f;
    if(type==='LR2'){return 1/Math.sqrt(1+Math.pow(x,4))}
    if(type==='LR4'){return 1/Math.sqrt(1+Math.pow(x,8))}
    if(type==='Butterworth'){return 1/Math.sqrt(1+Math.pow(x,4))}
    if(type==='Bessel'){
      const xx=(f/fc);
      const num=3;
      const den=Math.sqrt(Math.pow(xx,4)+3*Math.pow(xx,2)+3);
      return Math.min(1,num/den)
    }
    return 1/Math.sqrt(1+x*x)
  }
  function genFreq(){const arr=[];for(let p=Math.log10(20);p<=Math.log10(40000);p+=0.02){arr.push(10**p)}return arr}
  function wiringForHP(type){if(type==='LR4')return['C1(series)','L1(shunt)','C2(series)','L2(shunt)'];return['C(series)','L(shunt)']}
  function wiringForLP(type){if(type==='LR4')return['L1(series)','C1(shunt)','L2(series)','C2(shunt)'];return['L(series)','C(shunt)']}
  function formatWiringLine(prefix,parts,tail=''){return`${prefix} ${parts.map(p=>p).join(' → ')}${tail}`}
  let chart;
  function draw2Way(freq,series,toggles){
    const ctx=el('plot').getContext('2d');
    if(chart)chart.destroy();
    const ds=[];
    if(toggles.showWoo)ds.push({label:'Woofer',data:series.wIdeal,borderColor:'#d33',pointRadius:0});
    if(toggles.showTwe)ds.push({label:'Tweeter',data:series.tIdeal,borderColor:'#06c',pointRadius:0});
    if(toggles.showSum)ds.push({label:'Sum',data:series.sumIdeal,borderColor:'#000',pointRadius:0});
    if(toggles.showSnapped){
      if(toggles.showWoo)ds.push({label:'Woofer (Snapped)',data:series.wSnap,borderColor:'#f88',pointRadius:0,borderDash:[4,2]});
      if(toggles.showTwe)ds.push({label:'Tweeter (Snapped)',data:series.tSnap,borderColor:'#8af',pointRadius:0,borderDash:[4,2]});
      if(toggles.showSum)ds.push({label:'Sum (Snapped)',data:series.sumSnap,borderColor:'#666',pointRadius:0,borderDash:[4,2]});
    }
    if(toggles.showDelta){ ds.push({label:'Delta (Ideal - Snapped)',data:series.delta,borderColor:'#0b6',pointRadius:0,borderDash:[2,4]}); }
    chart=new Chart(ctx,{type:'line',data:{labels:freq,datasets:ds},options:{responsive:true,interaction:{mode:'nearest',intersect:false},plugins:{legend:{position:'bottom'}},scales:{x:{type:'logarithmic',min:20,max:40000,ticks:{callback:(v)=>v},title:{display:true,text:'Hz'}},y:{title:{display:true,text:'dB'},suggestedMin:-50,suggestedMax:10}}});
  }
  function run(){
    const system=el('system').value;
    const wz=+el('wz').value||8, wspl=+el('wspl').value||90, wtype=el('wtype').value;
    const tz=+el('tz').value||8, tspl=+el('tspl').value||98, ttype=el('ttype').value;
    const fc=+el('fc1').value||1800;
    const basis=el('spl-basis').value;
    let systemSPL=Math.min(wspl,tspl);
    let basisText='最小能率';
    if(basis==='targetSystemSPL'){
      const t=+el('target-spl').value; if(t>0){ systemSPL=Math.min(t,systemSPL); basisText=`手動入力（${t.toFixed(1)} dB）`; }
    }
    const lpadMode=el('tlpad').value;
    const needAtt=Math.max(0, tspl-systemSPL);
    const lp=(lpadMode==='auto')? lpad(tz, needAtt) : {Rs:0,Rp:Infinity,Zin:tz,A:1};
    const RsSnap=(lpadMode==='auto'&&lp.Rs>0)? snapR(lp.Rs,0.05):null;
    const RpSnap=(lpadMode==='auto'&&isFinite(lp.Rp))? snapR(lp.Rp,0.05):null;
    const ZinSnap=(lpadMode==='auto'&&RsSnap&&RpSnap)? (RsSnap.val+1/(1/RpSnap.val+1/tz)) : lp.Zin;
    const zbl=(el('wzobel').value==='on')? estimateZobel(wz,fc):null;
    const freq=genFreq();
    const wMag=freq.map(f=> magLP(wtype,f,fc));
    const tMagIdeal=freq.map(f=> magHP(ttype,f,fc));
    const tMag=freq.map((f,i)=> tMagIdeal[i]*(lpadMode==='auto'? 1/lp.A : 1));
    const wIdealDb=wMag.map(m=> ratioToDb(m) + (wspl-systemSPL));
    const tIdealDb=tMagIdeal.map(m=> ratioToDb(m) + (tspl-systemSPL));
    const tSnapDb=tMag.map(m=> ratioToDb(m) + (tspl-systemSPL) - (lpadMode==='auto'? needAtt:0));
    const invert = (autoPol(wtype,ttype)==='invert');
    function sumDb(aDb,bDb,inv){ const a=dbToRatio(aDb), b=dbToRatio(bDb)*(inv?-1:1); const mag=Math.sqrt(Math.max(0,a*a+b*b)); return ratioToDb(mag); }
    const sumIdealDb=freq.map((_,i)=> sumDb(wIdealDb[i], tIdealDb[i], invert));
    const sumSnapDb=freq.map((_,i)=> sumDb(wIdealDb[i], tSnapDb[i], invert));
    const deltaDb=freq.map((_,i)=> sumIdealDb[i]-sumSnapDb[i]);
    draw2Way(freq,{ wIdeal:wIdealDb, tIdeal:tIdealDb, sumIdeal:sumIdealDb, wSnap:wIdealDb, tSnap:tSnapDb, sumSnap:sumSnapDb, delta:deltaDb },{ showWoo:el('show-woo').checked, showTwe:el('show-twe').checked, showSum:el('show-sum').checked, showSnapped:el('show-snapped').checked, showDelta:el('show-delta').checked });
    const slopeText = s => s==='LR4'? 'LR4（24 dB/oct）': s==='LR2'? 'LR2（12 dB/oct）' : s;
    const lines=[];
    lines.push('---');
    lines.push(`・システム：${system}`);
    lines.push(`・SPL基準: ${basisText}`);
    lines.push(`・目標クロス周波数：${(fc/1000).toFixed(2)} kHz`);
    lines.push(`・HP（Tweeter）：${tz}Ω、能率${tspl.toFixed(1)}dB、特性${slopeText(ttype)}`);
    lines.push(`・LP（Woofer）：${wz}Ω、能率${wspl.toFixed(1)}dB、特性${slopeText(wtype)}`);
    lines.push(`・Zobel（Woofer補正）：${zbl? '使用（ON）':'未使用（OFF）'}`);
    lines.push(`・L-pad（Tweeter減衰）：${lpadMode==='auto'? '約−'+needAtt.toFixed(1)+' dB（定インピ）':'OFF'}`);
    lines.push('---\n');
    lines.push('■ 配線順（概略）');
    const hp=wiringForHP(ttype); const lpw=wiringForLP(wtype);
    lines.push(formatWiringLine('[入力(＋)] → HP：', hp, ' → L-pad(Rs→Rp) → Tweeter(＋)'));
    lines.push(formatWiringLine('           → LP：', lpw, ' → Woofer(＋) ／ Woofer端子＋−間に [Rz−Cz直列] を並列（Zobel）'));
    lines.push('[入力(−)] → Tweeter(−), Woofer(−)\n');
    lines.push('■ L-pad（ツイーター減衰）');
    if (lpadMode==='auto'){
      lines.push(`必要減衰: ${needAtt.toFixed(2)} dB`);
      lines.push(`理論 Rs: ${fmtOhm(lp.Rs)}, Rp: ${fmtOhm(lp.Rp)}, 入力Z: ${fmtOhm(lp.Zin)}`);
      if(RsSnap&&RpSnap){
        lines.push(`スナップ Rs: ${fmtOhm(RsSnap.val)} (${RsSnap.parts.join(' ')})`);
        lines.push(`スナップ Rp: ${fmtOhm(RpSnap.val)} (${RpSnap.parts.join(' ')})`);
        lines.push(`スナップ後 入力Z: ${fmtOhm(ZinSnap)}`);
      }else{
        lines.push('スナップ: 適合候補なし（±5%以内）');
      }
    } else { lines.push('OFF'); }
    lines.push('');
    lines.push('■ Zobel（Woofer補正）');
    if (zbl){ lines.push(`Rz = ${fmtOhm(zbl.Rz)}`); lines.push(`Cz = ${fmtCap(zbl.Cz)}（Re/Le内部推定）`); } else { lines.push('未適用'); }
    lines.push('');
    const L1=wz/(2*Math.PI*fc), C1=1/(2*Math.PI*tz*fc);
    lines.push('■ 参考（1次理想値の目安）');
    lines.push(`Low-pass L(series)：${fmtInd(L1)}`);
    lines.push(`High-pass C(series)：${fmtCap(C1)}`);
    el('results').textContent = lines.join('\n');
  }
  ['show-woo','show-twe','show-sum','show-snapped','show-delta'].forEach(id=>{ el(id).addEventListener('change', run); });
  el('calc').addEventListener('click', run);
  run();
</script>
</html>
